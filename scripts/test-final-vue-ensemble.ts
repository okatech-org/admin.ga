#!/usr/bin/env bun

/**
 * TEST FINAL DE LA VUE D'ENSEMBLE
 * Teste exactement ce que fait la page postes-emploi pour charger les statistiques
 */

async function testFinalVueEnsemble() {
  console.log('\n' + '='.repeat(70));
  console.log('ðŸŽ¯ TEST FINAL - VUE D\'ENSEMBLE PAGE POSTES-EMPLOI');
  console.log('='.repeat(70) + '\n');

  try {
    // Simuler exactement ce que fait la page loadInitialData
    console.log('ðŸš€ Simulation exacte du chargement initial de la page...');

    const [organismesResponse, statistiquesResponse] = await Promise.all([
      fetch('http://localhost:3000/api/rh/organismes'),
      fetch('http://localhost:3000/api/rh/statistiques')
    ]);

    // Test organismes
    if (!organismesResponse.ok) {
      throw new Error(`Organismes API Ã©chouÃ©: ${organismesResponse.status}`);
    }

    const organismesResult = await organismesResponse.json();
    if (!organismesResult.success) {
      throw new Error('API organismes retourne success: false');
    }

    console.log('   âœ… Organismes chargÃ©s:', organismesResult.data.organismes.length);

    // Test statistiques
    if (!statistiquesResponse.ok) {
      throw new Error(`Statistiques API Ã©chouÃ©: ${statistiquesResponse.status}`);
    }

    const statistiquesResult = await statistiquesResponse.json();
    if (!statistiquesResult.success) {
      throw new Error('API statistiques retourne success: false');
    }

    console.log('   âœ… Statistiques chargÃ©es');

    // Transformer exactement comme dans la page (lignes 251-302)
    console.log('\nðŸ”„ Transformation des donnÃ©es (exactement comme la page)...');

    const rawStats = statistiquesResult.data;
    const vueEnsemble = rawStats['ðŸ“Š VUE D\'ENSEMBLE'] || {};
    const situationPostes = rawStats['ðŸ“‹ SITUATION DES POSTES'] || {};
    const ressourcesHumaines = rawStats['ðŸ‘¥ RESSOURCES HUMAINES'] || {};
    const statistiquesDetailees = rawStats['statistiques_detaillees'] || {};

    console.log('   ðŸ“Š DonnÃ©es extraites:', {
      'VUE D\'ENSEMBLE': Object.keys(vueEnsemble),
      'SITUATION DES POSTES': Object.keys(situationPostes),
      'RESSOURCES HUMAINES': Object.keys(ressourcesHumaines),
      'STATISTIQUES DÃ‰TAILLÃ‰ES': Object.keys(statistiquesDetailees).slice(0, 5) // Premiers 5 seulement
    });

    const statsData = {
      global: {
        total_organismes: vueEnsemble['Total organismes'] || 0,
        total_postes: vueEnsemble['Total postes'] || 0,
        total_fonctionnaires: vueEnsemble['Total fonctionnaires'] || 0,
        taux_occupation: statistiquesDetailees.taux_occupation || 60,
        postes_vacants: situationPostes['Postes vacants'] || 0,
        fonctionnaires_disponibles: ressourcesHumaines['En attente d\'affectation'] || 0
      }
    };

    console.log('   âœ… Transformation rÃ©ussie');

    // Test des 4 cartes StatCard de la vue d'ensemble
    console.log('\nðŸ“Š Test des 4 cartes de statistiques (StatCard)...');

    const cartes = [
      {
        nom: 'Organismes',
        valeur: statsData.global.total_organismes,
        sousTitre: 'Administration publique',
        test: statsData.global.total_organismes === 141
      },
      {
        nom: 'Postes',
        valeur: statsData.global.total_postes,
        sousTitre: `${statsData.global.postes_vacants} vacants`,
        test: statsData.global.total_postes > 0 && statsData.global.postes_vacants > 0
      },
      {
        nom: 'Fonctionnaires',
        valeur: statsData.global.total_fonctionnaires,
        sousTitre: `${statsData.global.fonctionnaires_disponibles} disponibles`,
        test: statsData.global.total_fonctionnaires > 0 && statsData.global.fonctionnaires_disponibles > 0
      },
      {
        nom: 'Taux d\'Occupation',
        valeur: `${statsData.global.taux_occupation}%`,
        sousTitre: '',
        test: statsData.global.taux_occupation >= 50 && statsData.global.taux_occupation <= 80
      }
    ];

    let cartesValides = 0;
    cartes.forEach(carte => {
      if (carte.test) {
        console.log(`   âœ… ${carte.nom}: ${carte.valeur}${carte.sousTitre ? ` (${carte.sousTitre})` : ''}`);
        cartesValides++;
      } else {
        console.log(`   âŒ ${carte.nom}: ${carte.valeur}${carte.sousTitre ? ` (${carte.sousTitre})` : ''}`);
      }
    });

    // Test des sections additionnelles
    console.log('\nðŸŽ¯ Test des sections additionnelles...');

    // Section postes stratÃ©giques (sera remplie aprÃ¨s loadPostes)
    console.log('   ðŸ“‹ Postes stratÃ©giques: ChargÃ©s dynamiquement via loadPostes()');

    // Section fonctionnaires disponibles (sera remplie aprÃ¨s loadFonctionnaires)
    console.log('   ðŸ‘¥ Personnel en attente: ChargÃ© dynamiquement via loadFonctionnaires()');

    // Section actions rapides
    console.log('   âš¡ Actions rapides: Statique (nouveau poste, recherche, etc.)');

    // Calcul des mÃ©triques par niveau (comme dans la page)
    console.log('\nðŸ“ˆ Calcul des mÃ©triques par niveau...');

    const parNiveau = {
      DIRECTION: {
        postes_total: Math.floor((vueEnsemble['Total postes'] || 0) * 0.15),
        postes_vacants: Math.floor((situationPostes['Postes vacants'] || 0) * 0.15)
      },
      ENCADREMENT: {
        postes_total: Math.floor((vueEnsemble['Total postes'] || 0) * 0.25),
        postes_vacants: Math.floor((situationPostes['Postes vacants'] || 0) * 0.25)
      },
      EXÃ‰CUTION: {
        postes_total: Math.floor((vueEnsemble['Total postes'] || 0) * 0.60),
        postes_vacants: Math.floor((situationPostes['Postes vacants'] || 0) * 0.60)
      }
    };

    Object.entries(parNiveau).forEach(([niveau, stats]) => {
      console.log(`   ðŸ“Š ${niveau}: ${stats.postes_total} postes (${stats.postes_vacants} vacants)`);
    });

    // RÃ©sultat final
    console.log('\n' + '='.repeat(50));
    console.log('ðŸŽ¯ RÃ‰SULTAT FINAL');
    console.log('='.repeat(50));

    if (cartesValides === cartes.length) {
      console.log('\nðŸŽ‰ TOUTES LES CARTES STATISTIQUES SONT VALIDES !');

      console.log('\nâœ¨ LA VUE D\'ENSEMBLE AFFICHE MAINTENANT:');
      console.log(`   ðŸ“Š ${statsData.global.total_organismes} organismes officiels gabonais`);
      console.log(`   ðŸ“‹ ${statsData.global.total_postes} postes administratifs`);
      console.log(`      â””â”€â”€ ${statsData.global.postes_vacants} postes vacants (offres d'emploi)`);
      console.log(`   ðŸ‘¥ ${statsData.global.total_fonctionnaires} fonctionnaires`);
      console.log(`      â””â”€â”€ ${statsData.global.fonctionnaires_disponibles} en attente d'affectation`);
      console.log(`   ðŸ“ˆ ${statsData.global.taux_occupation}% taux d'occupation`);

      console.log('\nðŸŽ¯ RÃ‰PARTITION PAR NIVEAU:');
      Object.entries(parNiveau).forEach(([niveau, stats]) => {
        const pourcentage = ((stats.postes_vacants / stats.postes_total) * 100).toFixed(0);
        console.log(`   â€¢ ${niveau}: ${stats.postes_vacants}/${stats.postes_total} vacants (${pourcentage}%)`);
      });

      console.log('\nðŸš€ ACTIONS RECOMMANDÃ‰ES:');
      console.log('   1. Actualiser la page http://localhost:3000/super-admin/postes-emploi');
      console.log('   2. Cliquer sur l\'onglet "Vue d\'ensemble"');
      console.log('   3. VÃ©rifier que les 4 cartes affichent les vraies donnÃ©es');
      console.log('   4. Les sections "Postes StratÃ©giques" et "Personnel en Attente" se remplissent en cliquant sur leurs onglets respectifs');

      return {
        success: true,
        statistiques: statsData,
        cartes_valides: cartesValides,
        total_cartes: cartes.length
      };
    } else {
      console.log(`\nâš ï¸  PROBLÃˆME DÃ‰TECTÃ‰:`);
      console.log(`   â€¢ ${cartes.length - cartesValides} carte(s) invalide(s) sur ${cartes.length}`);
      console.log('\nðŸ”§ VÃ‰RIFICATIONS NÃ‰CESSAIRES:');
      console.log('   â€¢ Structure des donnÃ©es statistiques');
      console.log('   â€¢ Transformation des donnÃ©es dans la page');
      console.log('   â€¢ Affichage des composants StatCard');

      return {
        success: false,
        cartes_valides: cartesValides,
        total_cartes: cartes.length
      };
    }

  } catch (error) {
    console.error('\nâŒ ERREUR DURANT LE TEST:', error);
    console.log('\nâ„¹ï¸  VÃ©rifications:');
    console.log('   â€¢ Serveur de dÃ©veloppement actif sur localhost:3000');
    console.log('   â€¢ APIs /api/rh/organismes et /api/rh/statistiques accessibles');
    console.log('   â€¢ SystÃ¨me RH gabonais initialisÃ©');

    return {
      success: false,
      error: error instanceof Error ? error.message : 'Erreur inconnue'
    };
  }
}

// Fonction principale
async function main() {
  console.log('ðŸŽ¯ Test final de la vue d\'ensemble...');
  console.log('â„¹ï¸  Ce test simule exactement le comportement de la page postes-emploi');

  try {
    const result = await testFinalVueEnsemble();

    if (result.success) {
      console.log('\nâœ… TEST FINAL RÃ‰USSI !');
      console.log('\nðŸŽŠ La vue d\'ensemble de la page postes-emploi charge maintenant toutes les statistiques RH !');
      process.exit(0);
    } else {
      console.log('\nâŒ Test final Ã©chouÃ©');
      console.log(`   Cartes valides: ${result.cartes_valides}/${result.total_cartes}`);
      process.exit(1);
    }
  } catch (error) {
    console.error('\nðŸ’¥ Erreur fatale:', error);
    process.exit(1);
  }
}

// Lancer le test final
setTimeout(() => {
  main().catch(console.error);
}, 500);
