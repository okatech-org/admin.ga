name: 🔍 Validate Secrets Configuration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement à valider (all, app, staging, production, notifications)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - app
          - staging
          - production
          - notifications
  schedule:
    # Vérification hebdomadaire des secrets (dimanche à 00:00 UTC)
    - cron: '0 0 * * 0'

# env:
# Note: Les secrets sont vérifiés directement dans les steps pour éviter les avertissements
# quand ils ne sont pas configurés

jobs:
  validate-secrets:
    name: 🛡️ Validate Required Secrets
    runs-on: ubuntu-latest

    steps:
    - name: 📋 Validate Application Secrets
      if: ${{ github.event.inputs.environment == 'all' || github.event.inputs.environment == 'app' || github.event.inputs.environment == '' }}
      continue-on-error: true
      run: |
        echo "🔍 Validation des secrets d'application..."
        MISSING_SECRETS=()

        [ -z "${{ secrets.DATABASE_URL }}" ] && MISSING_SECRETS+=("DATABASE_URL")
        [ -z "${{ secrets.NEXTAUTH_SECRET }}" ] && MISSING_SECRETS+=("NEXTAUTH_SECRET")
        [ -z "${{ secrets.NEXTAUTH_URL }}" ] && MISSING_SECRETS+=("NEXTAUTH_URL")
        [ -z "${{ secrets.SNYK_TOKEN }}" ] && MISSING_SECRETS+=("SNYK_TOKEN")

        if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
          echo "⚠️ Secrets d'application manquants (optionnels):"
          printf '  - %s\n' "${MISSING_SECRETS[@]}"
        else
          echo "✅ Tous les secrets d'application sont configurés!"
        fi

    - name: 📋 Validate Staging Secrets
      if: ${{ github.event.inputs.environment == 'all' || github.event.inputs.environment == 'staging' || github.event.inputs.environment == '' }}
      continue-on-error: true
      run: |
        echo "🔍 Validation des secrets de staging..."
        MISSING_SECRETS=()

        [ -z "${{ secrets.STAGING_HOST }}" ] && MISSING_SECRETS+=("STAGING_HOST")
        [ -z "${{ secrets.STAGING_USER }}" ] && MISSING_SECRETS+=("STAGING_USER")
        [ -z "${{ secrets.STAGING_SSH_KEY }}" ] && MISSING_SECRETS+=("STAGING_SSH_KEY")
        [ -z "${{ secrets.STAGING_URL }}" ] && MISSING_SECRETS+=("STAGING_URL")

        if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
          echo "⚠️  Secrets de staging manquants (optionnels):"
          printf '  - %s\n' "${MISSING_SECRETS[@]}"
        else
          echo "✅ Tous les secrets de staging sont configurés!"
        fi

    - name: 📋 Validate Production Secrets
      if: ${{ github.event.inputs.environment == 'all' || github.event.inputs.environment == 'production' || github.event.inputs.environment == '' }}
      continue-on-error: true
      run: |
        echo "🔍 Validation des secrets de production..."
        MISSING_SECRETS=()

        [ -z "${{ secrets.PRODUCTION_HOST }}" ] && MISSING_SECRETS+=("PRODUCTION_HOST")
        [ -z "${{ secrets.PRODUCTION_USER }}" ] && MISSING_SECRETS+=("PRODUCTION_USER")
        [ -z "${{ secrets.PRODUCTION_SSH_KEY }}" ] && MISSING_SECRETS+=("PRODUCTION_SSH_KEY")
        [ -z "${{ secrets.PRODUCTION_URL }}" ] && MISSING_SECRETS+=("PRODUCTION_URL")

        if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
          echo "⚠️  Secrets de production manquants (optionnels):"
          printf '  - %s\n' "${MISSING_SECRETS[@]}"
        else
          echo "✅ Tous les secrets de production sont configurés!"
        fi

    - name: 📋 Validate Notification Secrets
      if: ${{ github.event.inputs.environment == 'all' || github.event.inputs.environment == 'notifications' || github.event.inputs.environment == '' }}
      continue-on-error: true
      run: |
        echo "🔍 Validation des secrets de notification..."
        MISSING_SECRETS=()

        [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ] && MISSING_SECRETS+=("SLACK_WEBHOOK_URL")
        [ -z "${{ secrets.MONITORING_WEBHOOK }}" ] && MISSING_SECRETS+=("MONITORING_WEBHOOK")

        if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
          echo "⚠️  Secrets de notification manquants (optionnels):"
          printf '  - %s\n' "${MISSING_SECRETS[@]}"
        else
          echo "✅ Tous les secrets de notification sont configurés!"
        fi

    - name: 📋 Configuration Guide
      if: failure()
      run: |
        echo ""
        echo "📋 Pour configurer les secrets manquants:"
        echo "1. Allez dans Settings > Secrets and variables > Actions"
        echo "2. Cliquez sur 'New repository secret'"
        echo "3. Ajoutez chaque secret manquant"
        echo ""
        echo "📖 Voir la documentation complète dans docs/DEPLOYMENT_GUIDE.md"

    - name: 📊 Generate Secrets Report
      if: success()
      run: |
        echo "📊 Rapport de configuration des secrets"
        echo "========================================"
        echo "✅ Secrets d'application: Configurés"
        echo "✅ Configuration validée avec succès!"
        echo ""
        echo "🎉 Prêt pour le déploiement!"
